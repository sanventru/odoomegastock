<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de formulario extendida para Lotes -->
    <record id="view_stock_lot_form_extended" model="ir.ui.view">
        <field name="name">stock.lot.form.extended</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.view_production_lot_form"/>
        <field name="arch" type="xml">
            
            <!-- Agregar campos después del producto -->
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="production_line" readonly="1"/>
                <field name="quality_state"/>
            </xpath>
            
            <!-- Agregar pestaña de trazabilidad -->
            <xpath expr="//notebook" position="inside">
                <page string="Información de Producción" name="production_info">
                    <group>
                        <group string="Producción">
                            <field name="production_id"/>
                            <field name="workorder_id"/>
                            <field name="pallet_number"/>
                            <field name="batch_code"/>
                            <field name="production_date"/>
                            <field name="shift"/>
                        </group>
                        <group string="Personal">
                            <field name="operator_id"/>
                            <field name="supervisor_id"/>
                            <field name="quality_inspector_id"/>
                        </group>
                    </group>
                </page>
                
                <page string="Especificaciones Técnicas" name="technical_specs">
                    <group>
                        <group string="Propiedades del Material">
                            <field name="grammage"/>
                            <field name="thickness"/>
                            <field name="moisture"/>
                            <field name="resistance_test"/>
                        </group>
                        <group string="Dimensiones y Empaque">
                            <field name="product_length"/>
                            <field name="product_width"/>
                            <field name="units_per_package"/>
                            <field name="total_packages"/>
                        </group>
                    </group>
                </page>
                
                <page string="Control de Calidad" name="quality_control">
                    <group>
                        <group string="Estado de Calidad">
                            <field name="quality_state"/>
                            <field name="quality_notes" widget="text"/>
                            <field name="rejection_reason" widget="text" 
                                   attrs="{'invisible': [('quality_state', '!=', 'rejected')]}"/>
                        </group>
                        <group string="Acciones">
                            <button name="action_approve_quality" 
                                    type="object" 
                                    string="Aprobar Calidad"
                                    class="btn-success"
                                    attrs="{'invisible': [('quality_state', 'in', ['approved', 'rejected'])]}"/>
                            <button name="action_reject_quality" 
                                    type="object" 
                                    string="Rechazar Calidad"
                                    class="btn-danger"
                                    attrs="{'invisible': [('quality_state', 'in', ['approved', 'rejected'])]}"/>
                            <button name="action_quarantine" 
                                    type="object" 
                                    string="Poner en Cuarentena"
                                    class="btn-warning"
                                    attrs="{'invisible': [('quality_state', '=', 'quarantine')]}"/>
                        </group>
                    </group>
                </page>
                
                <page string="Trazabilidad" name="traceability">
                    <group>
                        <group string="Materias Primas">
                            <field name="raw_material_lots" widget="many2many_tags"/>
                            <field name="supplier_batch"/>
                        </group>
                        <group string="Acciones">
                            <button name="action_view_traceability" 
                                    type="object" 
                                    string="Ver Trazabilidad Completa"
                                    class="btn-primary"/>
                            <button name="action_print_traceability_label" 
                                    type="object" 
                                    string="Imprimir Etiqueta"
                                    class="btn-secondary"/>
                        </group>
                    </group>
                </page>
            </xpath>
            
        </field>
    </record>

    <!-- Vista de lista extendida -->
    <record id="view_stock_lot_tree_extended" model="ir.ui.view">
        <field name="name">stock.lot.tree.extended</field>
        <field name="model">stock.lot</field>
        <field name="inherit_id" ref="stock.stock_production_lot_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="production_line" optional="show"/>
                <field name="quality_state" optional="show"/>
                <field name="pallet_number" optional="hide"/>
                <field name="production_date" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Vista de trazabilidad especializada -->
    <record id="view_stock_lot_traceability_form" model="ir.ui.view">
        <field name="name">stock.lot.traceability.form</field>
        <field name="model">stock.lot</field>
        <field name="arch" type="xml">
            <form string="Trazabilidad del Lote" create="false" edit="false">
                <header>
                    <button name="action_print_traceability_label" 
                            type="object" 
                            string="Imprimir Etiqueta"
                            class="btn-primary"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                        <h2>
                            <field name="product_id" readonly="1"/>
                        </h2>
                    </div>
                    
                    <group>
                        <group string="Información de Producción">
                            <field name="production_id" readonly="1"/>
                            <field name="production_line" readonly="1"/>
                            <field name="production_date" readonly="1"/>
                            <field name="shift" readonly="1"/>
                        </group>
                        <group string="Personal Responsable">
                            <field name="operator_id" readonly="1"/>
                            <field name="supervisor_id" readonly="1"/>
                            <field name="quality_inspector_id" readonly="1"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Especificaciones">
                            <field name="grammage" readonly="1"/>
                            <field name="thickness" readonly="1"/>
                            <field name="moisture" readonly="1"/>
                            <field name="resistance_test" readonly="1"/>
                        </group>
                        <group string="Estado">
                            <field name="quality_state" readonly="1"/>
                            <field name="pallet_number" readonly="1"/>
                            <field name="batch_code" readonly="1"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Materias Primas Utilizadas">
                            <field name="raw_material_lots" readonly="1">
                                <tree>
                                    <field name="name"/>
                                    <field name="product_id"/>
                                    <field name="supplier_batch"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Observaciones">
                            <field name="quality_notes" readonly="1" widget="text"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

</odoo>