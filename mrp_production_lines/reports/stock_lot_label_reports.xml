<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Reporte de Etiquetas de Trazabilidad para Lotes -->
    <report 
        id="action_stock_lot_traceability_label_report"
        string="Etiqueta de Trazabilidad"
        model="stock.lot" 
        report_type="qweb-pdf"
        name="mrp_production_lines.stock_lot_traceability_label_template"
        file="mrp_production_lines.stock_lot_traceability_label_template"
        attachment_use="False"
        paperformat="mrp_production_lines.paperformat_traceability_label"/>

    <!-- Formato de papel para etiquetas de trazabilidad -->
    <record id="paperformat_traceability_label" model="report.paperformat">
        <field name="name">Etiqueta Trazabilidad 120x80mm</field>
        <field name="default" eval="False"/>
        <field name="format">custom</field>
        <field name="page_height">80</field>
        <field name="page_width">120</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">3</field>
        <field name="margin_bottom">3</field>
        <field name="margin_left">3</field>
        <field name="margin_right">3</field>
        <field name="header_line" eval="False"/>
        <field name="header_spacing">0</field>
        <field name="dpi">96</field>
    </record>

    <!-- Template principal de etiquetas de trazabilidad -->
    <template id="stock_lot_traceability_label_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="lot">
                <div class="page" style="width: 114mm; height: 74mm; border: 2px solid #000; padding: 2mm; font-family: Arial; font-size: 7pt;">
                    
                    <!-- Header con información del lote -->
                    <div style="text-align: center; font-weight: bold; font-size: 9pt; border-bottom: 1px solid #333; padding-bottom: 2mm; margin-bottom: 2mm; background-color: #f0f0f0;">
                        TRAZABILIDAD - LOTE <t t-esc="lot.name"/>
                    </div>
                    
                    <!-- Información principal en dos columnas -->
                    <table style="width: 100%; font-size: 7pt;">
                        <tr>
                            <td style="width: 50%; vertical-align: top;">
                                <!-- Columna izquierda -->
                                <table style="width: 100%;">
                                    <tr>
                                        <td style="width: 35%;"><strong>Producto:</strong></td>
                                        <td style="width: 65%; font-size: 6pt;"><t t-esc="lot.product_id.name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Línea:</strong></td>
                                        <td><t t-esc="dict(lot._fields['production_line'].selection).get(lot.production_line, 'N/A')"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Producción:</strong></td>
                                        <td><t t-esc="lot.production_id.name or 'N/A'"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Fecha Prod:</strong></td>
                                        <td><t t-esc="lot.production_date and lot.production_date.strftime('%d/%m/%Y %H:%M') or 'N/A'"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Operador:</strong></td>
                                        <td><t t-esc="lot.operator_id.name or 'N/A'"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Turno:</strong></td>
                                        <td><t t-esc="dict(lot._fields['shift'].selection).get(lot.shift, 'N/A')"/></td>
                                    </tr>
                                </table>
                            </td>
                            <td style="width: 50%; vertical-align: top; padding-left: 3mm;">
                                <!-- Columna derecha -->
                                <table style="width: 100%;">
                                    <tr>
                                        <td style="width: 35%;"><strong>Pallet:</strong></td>
                                        <td style="width: 65%;"><t t-esc="lot.pallet_number or 'N/A'"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Lote Prod:</strong></td>
                                        <td><t t-esc="lot.batch_code or 'N/A'"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Calidad:</strong></td>
                                        <td>
                                            <span t-if="lot.quality_state == 'approved'" style="color: green; font-weight: bold;">✓ APROBADO</span>
                                            <span t-elif="lot.quality_state == 'rejected'" style="color: red; font-weight: bold;">✗ RECHAZADO</span>
                                            <span t-elif="lot.quality_state == 'quarantine'" style="color: orange; font-weight: bold;">⚠ CUARENTENA</span>
                                            <span t-else="" style="color: gray;">PENDIENTE</span>
                                        </td>
                                    </tr>
                                    <tr t-if="lot.grammage">
                                        <td><strong>Gramaje:</strong></td>
                                        <td><t t-esc="lot.grammage"/> g/m²</td>
                                    </tr>
                                    <tr t-if="lot.thickness">
                                        <td><strong>Grosor:</strong></td>
                                        <td><t t-esc="lot.thickness"/> mm</td>
                                    </tr>
                                    <tr t-if="lot.moisture">
                                        <td><strong>Humedad:</strong></td>
                                        <td><t t-esc="lot.moisture"/>%</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Dimensiones si están disponibles -->
                    <t t-if="lot.product_length or lot.product_width">
                        <div style="margin-top: 2mm; font-size: 6pt; border-top: 1px dotted #ccc; padding-top: 1mm;">
                            <strong>Dimensiones:</strong> 
                            <t t-if="lot.product_length"><t t-esc="lot.product_length"/>mm</t>
                            <t t-if="lot.product_length and lot.product_width"> x </t>
                            <t t-if="lot.product_width"><t t-esc="lot.product_width"/>mm</t>
                            <t t-if="lot.units_per_package"> | <t t-esc="lot.units_per_package"/> unidades/paquete</t>
                        </div>
                    </t>
                    
                    <!-- Materias primas utilizadas -->
                    <t t-if="lot.raw_material_lots">
                        <div style="margin-top: 2mm; font-size: 6pt; border-top: 1px dotted #ccc; padding-top: 1mm;">
                            <strong>Materias Primas:</strong>
                            <t t-foreach="lot.raw_material_lots" t-as="raw_lot">
                                <span style="margin-right: 3mm;"><t t-esc="raw_lot.name"/></span>
                            </t>
                        </div>
                    </t>
                    
                    <!-- Test de resistencia si existe -->
                    <t t-if="lot.resistance_test">
                        <div style="margin-top: 1mm; font-size: 6pt;">
                            <strong>Test:</strong> <t t-esc="lot.resistance_test"/>
                        </div>
                    </t>
                    
                    <!-- Código de barras del lote -->
                    <div style="text-align: center; margin-top: 2mm;">
                        <img t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;width=%s&amp;height=%s' % ('Code128', lot.name, 250, 40)" style="width: 70mm; height: 6mm;"/>
                        <div style="font-size: 6pt; margin-top: 1mm;">
                            <t t-esc="lot.name"/>
                        </div>
                    </div>
                    
                    <!-- Footer con información del inspector -->
                    <div style="position: absolute; bottom: 2mm; right: 2mm; font-size: 5pt; color: #666;">
                        <t t-if="lot.quality_inspector_id">
                            Inspector: <t t-esc="lot.quality_inspector_id.name"/>
                        </t>
                    </div>
                    
                </div>
            </t>
        </t>
    </template>

    <!-- Template simplificado para etiquetas pequeñas -->
    <template id="stock_lot_simple_label_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="lot">
                <div class="page" style="width: 60mm; height: 40mm; border: 1px solid #000; padding: 2mm; font-family: Arial; font-size: 6pt;">
                    
                    <!-- Información básica -->
                    <div style="text-align: center; font-weight: bold; font-size: 8pt;">
                        <t t-esc="lot.name"/>
                    </div>
                    
                    <table style="width: 100%; font-size: 6pt; margin-top: 1mm;">
                        <tr>
                            <td><strong>Producto:</strong></td>
                            <td style="font-size: 5pt;"><t t-esc="lot.product_id.name"/></td>
                        </tr>
                        <tr>
                            <td><strong>Fecha:</strong></td>
                            <td><t t-esc="lot.production_date and lot.production_date.strftime('%d/%m/%Y') or 'N/A'"/></td>
                        </tr>
                        <tr t-if="lot.pallet_number">
                            <td><strong>Pallet:</strong></td>
                            <td><t t-esc="lot.pallet_number"/></td>
                        </tr>
                        <tr>
                            <td><strong>Estado:</strong></td>
                            <td>
                                <span t-if="lot.quality_state == 'approved'" style="color: green;">OK</span>
                                <span t-elif="lot.quality_state == 'rejected'" style="color: red;">NOK</span>
                                <span t-else="">PEND</span>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Código de barras pequeño -->
                    <div style="text-align: center; margin-top: 2mm;">
                        <img t-att-src="'/report/barcode/?type=%s&amp;value=%s&amp;width=%s&amp;height=%s' % ('Code128', lot.name, 150, 25)" style="width: 40mm; height: 4mm;"/>
                    </div>
                    
                </div>
            </t>
        </t>
    </template>

</odoo>