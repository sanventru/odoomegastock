<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista de Lista de Pedidos -->
    <record id="view_production_order_tree" model="ir.ui.view">
        <field name="name">megastock.production.order.tree</field>
        <field name="model">megastock.production.order</field>
        <field name="arch" type="xml">
            <tree string="Pedidos de Producción" decoration-success="estado=='entregado'" decoration-warning="estado=='proceso'" decoration-info="estado=='planchas'" decoration-muted="estado=='ot'">
                <!-- Campos principales siempre visibles -->
                <field name="pedido"/>
                <field name="orden_produccion" optional="show"/>
                <field name="cliente"/>
                <field name="estado" widget="badge"/>

                <!-- Campos opcionales - Fechas -->
                <field name="fecha_pedido_cliente" optional="show"/>
                <field name="fecha_entrega_cliente" optional="show"/>
                <field name="fecha_produccion" optional="hide"/>

                <!-- Campos opcionales - Producto -->
                <field name="codigo" optional="show"/>
                <field name="descripcion" optional="hide"/>

                <field name="flauta" optional="hide"/>

                <!-- Campos opcionales - Cantidades -->
                <field name="cantidad" optional="show"/>
                <field name="cantidad_entregada" optional="show"/>
                <field name="porcentaje_cumplimiento" widget="percentage" optional="show"/>
                <field name="cavidad" optional="hide"/>

                <!-- Campos opcionales - Dimensiones -->
                <field name="largo" optional="hide"/>
                <field name="ancho" optional="hide"/>
                <field name="area_total" optional="hide"/>

                <!-- Campos opcionales - Materiales -->
                <field name="liner_interno_proveedor" optional="hide"/>
                <field name="medium_proveedor" optional="hide"/>
                <field name="liner_externo_proveedor" optional="hide"/>

                <!-- Campos opcionales - Especificaciones técnicas -->
                <field name="numero_troquel" optional="hide"/>
                <field name="ect_minimo" optional="hide"/>
                <field name="ect_real" optional="hide"/>
                <field name="peso" optional="hide"/>
                <field name="cortes" optional="hide"/>
                <field name="metros_lineales" optional="hide"/>

                <!-- Campos opcionales - Cantidades de material -->
                <field name="cantidad_liner_interno" optional="hide"/>
                <field name="cantidad_medium" optional="hide"/>
                <field name="cantidad_liner_externo" optional="hide"/>

                <!-- Campos opcionales - Planificación -->
                <field name="grupo_planificacion" optional="show"/>
                <field name="tipo_combinacion" optional="show"/>
                <field name="eficiencia" widget="percentage" optional="show"/>
                <field name="work_order_id" optional="show"/>
                <field name="ancho_utilizado" optional="hide"/>
                <field name="bobina_utilizada" optional="hide"/>
                <field name="sobrante" optional="hide"/>

                <!-- Campos opcionales - Otros -->
                <field name="cumplimiento" optional="hide"/>
            </tree>
        </field>
    </record>

    <!-- Vista de Formulario de Pedidos -->
    <record id="view_production_order_form" model="ir.ui.view">
        <field name="name">megastock.production.order.form</field>
        <field name="model">megastock.production.order</field>
        <field name="arch" type="xml">
            <form string="Pedido de Producción">
                <header>
                    <button name="action_planificar_ordenes" string="Planificar Órdenes" type="object" 
                            class="oe_highlight" icon="fa-cogs" 
                            attrs="{'invisible': [('estado', '!=', 'pendiente')]}"/>
                    <button name="action_generar_ordenes_trabajo" string="Generar Órdenes de Trabajo" type="object" 
                            class="oe_highlight" icon="fa-industry" 
                            attrs="{'invisible': ['|', ('grupo_planificacion', '=', False), ('work_order_id', '!=', False)]}"/>
                    <field name="estado" widget="statusbar" statusbar_visible="pendiente,ot,proceso,planchas,entregado"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="orden_produccion" placeholder="Número de Orden"/>
                        </h1>
                    </div>

                    <group>
                        <group name="order_info" string="Información del Pedido">
                            <field name="fecha_pedido_cliente"/>
                            <field name="cliente"/>
                            <field name="pedido"/>
                            <field name="codigo"/>
                            <field name="flauta"/>
                        </group>
                        <group name="delivery_info" string="Fechas y Entrega">
                            <field name="fecha_entrega_cliente"/>
                            <field name="fecha_produccion"/>
                            <field name="cumplimiento"/>
                            <field name="porcentaje_cumplimiento" widget="percentage"/>
                        </group>
                    </group>

                    <group>
                        <group name="product_specs" string="Especificaciones del Producto">
                            <field name="descripcion"/>
                            <field name="largo"/>
                            <field name="ancho"/>
                            <field name="cantidad"/>
                            <field name="cantidad_entregada"/>
                            <field name="cavidad"/>
                            <field name="area_total"/>
                        </group>
                        <group name="technical_specs" string="Especificaciones Técnicas">
                            <field name="numero_troquel" readonly="1"/>
                            <field name="ect_minimo"/>
                            <field name="ect_real"/>
                            <field name="peso"/>
                            <field name="cortes" readonly="1"/>
                            <field name="metros_lineales" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Materiales" name="materials">
                            <group>
                                <group string="Liner Interno">
                                    <field name="liner_interno_proveedor"/>
                                    <field name="liner_interno_ancho"/>
                                    <field name="liner_interno_gm"/>
                                    <field name="liner_interno_tipo"/>
                                    <field name="cantidad_liner_interno" readonly="1"/>
                                </group>
                                <group string="Medium">
                                    <field name="medium_proveedor"/>
                                    <field name="medium_ancho"/>
                                    <field name="medium_gm"/>
                                    <field name="medium_tipo"/>
                                    <field name="cantidad_medium" readonly="1"/>
                                </group>
                            </group>
                            <group>
                                <group string="Liner Externo">
                                    <field name="liner_externo_proveedor"/>
                                    <field name="liner_externo_ancho"/>
                                    <field name="liner_externo_gm"/>
                                    <field name="liner_externo_tipo"/>
                                    <field name="cantidad_liner_externo" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Planificación" name="planning" attrs="{'invisible': [('grupo_planificacion', '=', False)]}">
                            <group>
                                <group string="Optimización de Material">
                                    <field name="grupo_planificacion" readonly="1"/>
                                    <field name="tipo_combinacion" readonly="1"/>
                                    <field name="eficiencia" widget="percentage" readonly="1"/>
                                </group>
                                <group string="Detalles de Bobina">
                                    <field name="ancho_utilizado" readonly="1"/>
                                    <field name="bobina_utilizada" readonly="1"/>
                                    <field name="sobrante" readonly="1"/>
                                    <field name="metros_lineales_planificados" readonly="1"/>
                                    <field name="cortes_planificados" readonly="1"/>
                                </group>
                            </group>
                            <div class="alert alert-info" role="alert">
                                <strong>Información de Planificación:</strong>
                                <p>Esta orden ha sido optimizada mediante el algoritmo de trimado para minimizar el desperdicio de material.</p>
                                <ul>
                                    <li><strong>Grupo:</strong> Identifica qué órdenes se procesan juntas</li>
                                    <li><strong>Tipo:</strong> Individual, Dupla o Tripla según la combinación</li>
                                    <li><strong>Eficiencia:</strong> Porcentaje de aprovechamiento del material</li>
                                </ul>
                            </div>
                        </page>
                        <page string="Orden de Trabajo" name="work_order" attrs="{'invisible': [('work_order_id', '=', False)]}">
                            <group>
                                <field name="work_order_id" readonly="1"/>
                            </group>
                            <div class="alert alert-info" role="alert">
                                <strong>Información de Orden de Trabajo:</strong>
                                <p>Esta orden de producción está asignada a una orden de trabajo. Puedes ver los detalles completos haciendo clic en el enlace de arriba.</p>
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de Búsqueda -->
    <record id="view_production_order_search" model="ir.ui.view">
        <field name="name">megastock.production.order.search</field>
        <field name="model">megastock.production.order</field>
        <field name="arch" type="xml">
            <search string="Buscar Pedidos">
                <field name="pedido"/>
                <field name="cliente"/>
                <field name="codigo"/>
                <field name="descripcion"/>
                <field name="numero_troquel"/>

                <filter string="Pendientes" name="pendientes" domain="[('estado', '=', 'pendiente')]"/>
                <filter string="OT" name="ot" domain="[('estado', '=', 'ot')]"/>
                <filter string="En Proceso" name="proceso" domain="[('estado', '=', 'proceso')]"/>
                <filter string="Planchas" name="planchas" domain="[('estado', '=', 'planchas')]"/>
                <filter string="Entregados" name="entregados" domain="[('estado', '=', 'entregado')]"/>

                <separator/>
                <filter string="Planificadas" name="planificadas" domain="[('grupo_planificacion', '!=', False)]"/>
                <filter string="Sin Planificar" name="sin_planificar" domain="[('grupo_planificacion', '=', False), ('estado', '=', 'pendiente')]"/>
                <filter string="Duplas" name="duplas" domain="[('tipo_combinacion', '=', 'dupla')]"/>
                <filter string="Triplas" name="triplas" domain="[('tipo_combinacion', '=', 'tripla')]"/>
                <filter string="Alta Eficiencia" name="alta_eficiencia" domain="[('eficiencia', '&gt;=', 80)]"/>

                <separator/>
                <filter string="Este Mes" name="este_mes" domain="[('fecha_pedido_cliente', '&gt;=', (context_today() - relativedelta(months=1)).strftime('%Y-%m-01'))]"/>
                <filter string="Próximas Entregas" name="proximas_entregas" domain="[('fecha_entrega_cliente', '&gt;=', context_today()), ('fecha_entrega_cliente', '&lt;=', (context_today() + relativedelta(days=7)).strftime('%Y-%m-%d'))]"/>

                <group expand="0" string="Agrupar Por">
                    <filter string="Cliente" name="group_cliente" context="{'group_by': 'cliente'}"/>
                    <filter string="Estado" name="group_estado" context="{'group_by': 'estado'}"/>
                    <filter string="Grupo Planificación" name="group_planificacion" context="{'group_by': 'grupo_planificacion'}"/>
                    <filter string="Tipo Combinación" name="group_tipo_combinacion" context="{'group_by': 'tipo_combinacion'}"/>
                    <filter string="Fecha Pedido" name="group_fecha_pedido" context="{'group_by': 'fecha_pedido_cliente'}"/>
                    <filter string="Fecha Entrega" name="group_fecha_entrega" context="{'group_by': 'fecha_entrega_cliente'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Vista Kanban -->
    <record id="view_production_order_kanban" model="ir.ui.view">
        <field name="name">megastock.production.order.kanban</field>
        <field name="model">megastock.production.order</field>
        <field name="arch" type="xml">
            <kanban default_group_by="estado" class="o_kanban_small_column">
                <field name="orden_produccion"/>
                <field name="cliente"/>
                <field name="descripcion"/>
                <field name="cantidad"/>
                <field name="cantidad_entregada"/>
                <field name="fecha_entrega_cliente"/>
                <field name="estado"/>
                <field name="porcentaje_cumplimiento"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="orden_produccion"/>
                                        </strong>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <field name="cliente"/>
                                    <br/>
                                    <t t-if="record.descripcion.raw_value">
                                        <span t-esc="record.descripcion.value.substring(0, 50)"/>
                                        <t t-if="record.descripcion.value.length > 50">...</t>
                                    </t>
                                    <br/>
                                    <strong>Cantidad: </strong>
                                    <field name="cantidad"/>
                                    <t t-if="record.cantidad_entregada.raw_value">
                                        /                                        <field name="cantidad_entregada"/>
 entregadas
                                    </t>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <t t-if="record.fecha_entrega_cliente.raw_value">
                                            <i class="fa fa-calendar"/>
                                            <field name="fecha_entrega_cliente"/>
                                        </t>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="porcentaje_cumplimiento" widget="percentage"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Acción de Planificación Masiva -->
    <record id="action_planificar_ordenes_masivo" model="ir.actions.server">
        <field name="name">Planificar Órdenes Seleccionadas</field>
        <field name="model_id" ref="model_megastock_production_order"/>
        <field name="binding_model_id" ref="model_megastock_production_order"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    # Filtrar solo órdenes pendientes
    ordenes_pendientes = records.filtered(lambda r: r.estado == 'pendiente')
    if ordenes_pendientes:
        resultado = ordenes_pendientes[0]._optimizar_ordenes(ordenes_pendientes)
        action = {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'Planificación Masiva Completada',
                'message': f'Se han planificado {len(ordenes_pendientes)} órdenes en {resultado["grupos"]} grupos. Eficiencia promedio: {resultado["eficiencia_promedio"]:.1f}%',
                'type': 'success',
            }
        }
    else:
        action = {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'Sin órdenes válidas',
                'message': 'Solo se pueden planificar órdenes en estado pendiente.',
                'type': 'warning',
            }
        }
        </field>
    </record>

    <!-- Acción de Ventana -->
    <record id="action_production_order" model="ir.actions.act_window">
        <field name="name">Pedidos de Producción</field>
        <field name="res_model">megastock.production.order</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="search_view_id" ref="view_production_order_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡Crea tu primer pedido de producción!
            </p>
            <p>
                Los pedidos de producción te permiten gestionar y hacer seguimiento
                a todas las órdenes de fabricación de productos de cartón corrugado.
            </p>
        </field>
    </record>
</odoo>
