<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- ========== REPORTE PRINCIPAL: DASHBOARD DE EFICIENCIA ========== -->
        
        <record id="machine_efficiency_dashboard_action" model="ir.actions.act_window">
            <field name="name">Dashboard de Eficiencia de Máquinas</field>
            <field name="res_model">mrp.workcenter</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[]</field>
            <field name="context">{
                'search_default_operational': 1,
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Dashboard de Eficiencia y Disponibilidad de Máquinas MEGASTOCK
                </p>
                <p>
                    Monitoree el rendimiento de sus centros de trabajo en tiempo real:
                    <ul>
                        <li>OEE (Overall Equipment Effectiveness)</li>
                        <li>Disponibilidad, Rendimiento y Calidad</li>
                        <li>Costos energéticos y de mantenimiento</li>
                        <li>Estado actual de máquinas</li>
                    </ul>
                </p>
            </field>
        </record>
        
        <!-- Vista Kanban para Dashboard -->
        <record id="mrp_workcenter_efficiency_kanban_view" model="ir.ui.view">
            <field name="name">mrp.workcenter.efficiency.kanban</field>
            <field name="model">mrp.workcenter</field>
            <field name="arch" type="xml">
                <kanban>
                    <field name="name"/>
                    <field name="code"/>
                    <field name="machine_status"/>
                    <field name="oee_overall"/>
                    <field name="oee_availability"/>
                    <field name="oee_performance"/>
                    <field name="oee_quality"/>
                    <field name="energy_cost_per_hour"/>
                    <field name="real_capacity"/>
                    <field name="capacity_unit"/>
                    <field name="next_maintenance_date"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_global_click o_kanban_record_has_image_fill">
                                <div class="o_kanban_image_fill_left">
                                    <div class="o_kanban_image_inner_pic">
                                        <img t-att-src="kanban_image('mrp.workcenter', 'image_128', record.id.raw_value)" alt="Workcenter"/>
                                    </div>
                                </div>
                                
                                <div class="oe_kanban_details">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="name"/>
                                            </strong>
                                            <small class="o_kanban_record_subtitle text-muted">
                                                <field name="code"/> - 
                                                <span t-att-class="record.machine_status.raw_value === 'operational' ? 'text-success' : 
                                                                   record.machine_status.raw_value === 'maintenance' ? 'text-warning' : 
                                                                   record.machine_status.raw_value === 'breakdown' ? 'text-danger' : 'text-info'">
                                                    <field name="machine_status"/>
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="o_kanban_record_body">
                                        <!-- OEE Principal -->
                                        <div class="row mb-2">
                                            <div class="col-12">
                                                <div class="progress mb-1" style="height: 20px;">
                                                    <div class="progress-bar" 
                                                         t-att-class="record.oee_overall.raw_value >= 80 ? 'bg-success' : 
                                                                      record.oee_overall.raw_value >= 60 ? 'bg-warning' : 'bg-danger'"
                                                         t-att-style="'width: ' + record.oee_overall.raw_value + '%'">
                                                        <strong>OEE: <field name="oee_overall"/>%</strong>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Métricas OEE Detalladas -->
                                        <div class="row small">
                                            <div class="col-4 text-center">
                                                <div class="text-primary">
                                                    <i class="fa fa-clock-o"/> Disponib.
                                                </div>
                                                <strong><field name="oee_availability"/>%</strong>
                                            </div>
                                            <div class="col-4 text-center">
                                                <div class="text-info">
                                                    <i class="fa fa-tachometer"/> Rendim.
                                                </div>
                                                <strong><field name="oee_performance"/>%</strong>
                                            </div>
                                            <div class="col-4 text-center">
                                                <div class="text-success">
                                                    <i class="fa fa-check-circle"/> Calidad
                                                </div>
                                                <strong><field name="oee_quality"/>%</strong>
                                            </div>
                                        </div>
                                        
                                        <!-- Información Operativa -->
                                        <div class="row mt-2 small">
                                            <div class="col-6">
                                                <i class="fa fa-cogs text-primary"/> Capacidad:
                                                <br/><strong><field name="real_capacity"/> <field name="capacity_unit"/>/h</strong>
                                            </div>
                                            <div class="col-6">
                                                <i class="fa fa-bolt text-warning"/> Energía:
                                                <br/><strong>$<field name="energy_cost_per_hour"/>/h</strong>
                                            </div>
                                        </div>
                                        
                                        <!-- Próximo Mantenimiento -->
                                        <div class="row mt-2" t-if="record.next_maintenance_date.raw_value">
                                            <div class="col-12 small">
                                                <i class="fa fa-wrench text-secondary"/> Próximo mantenimiento:
                                                <br/><strong class="text-primary"><field name="next_maintenance_date"/></strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>
        
        <!-- Vista Tree Mejorada -->
        <record id="mrp_workcenter_efficiency_tree_view" model="ir.ui.view">
            <field name="name">mrp.workcenter.efficiency.tree</field>
            <field name="model">mrp.workcenter</field>
            <field name="arch" type="xml">
                <tree decoration-success="machine_status == 'operational'" 
                      decoration-warning="machine_status == 'maintenance'" 
                      decoration-danger="machine_status == 'breakdown'"
                      decoration-info="machine_status == 'setup'">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="machine_status" widget="badge" 
                           decoration-success="machine_status == 'operational'"
                           decoration-warning="machine_status == 'maintenance'"
                           decoration-danger="machine_status == 'breakdown'"/>
                    <field name="oee_overall" widget="progressbar"/>
                    <field name="oee_availability"/>
                    <field name="oee_performance"/>
                    <field name="oee_quality"/>
                    <field name="real_capacity"/>
                    <field name="capacity_unit"/>
                    <field name="energy_cost_per_hour" sum="Total Costo Energía"/>
                    <field name="costs_hour" sum="Total Costo Operativo"/>
                    <field name="next_maintenance_date"/>
                    <field name="main_operator_id"/>
                </tree>
            </field>
        </record>
        
        <!-- Búsquedas Predefinidas -->
        <record id="mrp_workcenter_efficiency_search_view" model="ir.ui.view">
            <field name="name">mrp.workcenter.efficiency.search</field>
            <field name="model">mrp.workcenter</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name" string="Centro de Trabajo"/>
                    <field name="code" string="Código"/>
                    <field name="main_operator_id" string="Operador Principal"/>
                    
                    <!-- Filtros por Estado -->
                    <filter name="operational" string="Operativas" 
                            domain="[('machine_status', '=', 'operational')]"/>
                    <filter name="maintenance" string="En Mantenimiento" 
                            domain="[('machine_status', '=', 'maintenance')]"/>
                    <filter name="breakdown" string="Averiadas" 
                            domain="[('machine_status', '=', 'breakdown')]"/>
                    
                    <!-- Filtros por OEE -->
                    <filter name="high_oee" string="OEE Alto (>80%)" 
                            domain="[('oee_overall', '>', 80)]"/>
                    <filter name="medium_oee" string="OEE Medio (60-80%)" 
                            domain="[('oee_overall', '>=', 60), ('oee_overall', '<=', 80)]"/>
                    <filter name="low_oee" string="OEE Bajo (<60%)" 
                            domain="[('oee_overall', '<', 60)]"/>
                    
                    <!-- Filtros por Mantenimiento -->
                    <filter name="maintenance_due" string="Mantenimiento Próximo" 
                            domain="[('next_maintenance_date', '<=', (context_today() + datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                    
                    <separator/>
                    
                    <!-- Agrupaciones -->
                    <group expand="0" string="Agrupar Por">
                        <filter name="group_by_status" string="Estado" context="{'group_by': 'machine_status'}"/>
                        <filter name="group_by_operator" string="Operador Principal" context="{'group_by': 'main_operator_id'}"/>
                    </group>
                </search>
            </field>
        </record>
        
        <!-- ========== REPORTE PDF: INFORME DE EFICIENCIA ========== -->
        
        <record id="machine_efficiency_report" model="ir.actions.report">
            <field name="name">Informe de Eficiencia de Máquinas</field>
            <field name="model">mrp.workcenter</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">megastock_machines.machine_efficiency_report_template</field>
            <field name="report_file">megastock_machines.machine_efficiency_report_template</field>
            <field name="binding_model_id" ref="mrp.model_mrp_workcenter"/>
            <field name="binding_type">report</field>
        </record>
        
        <!-- Template del Reporte PDF -->
        <template id="machine_efficiency_report_template">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="workcenter">
                    <t t-call="web.external_layout">
                        <div class="header">
                            <div class="row">
                                <div class="col-6">
                                    <img src="/megastock_base/static/img/megastock_logo.png" alt="MEGASTOCK" style="height: 60px;"/>
                                </div>
                                <div class="col-6 text-right">
                                    <h3>INFORME DE EFICIENCIA</h3>
                                    <p>Centro de Trabajo: <strong t-field="workcenter.name"/></p>
                                    <p>Fecha: <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y %H:%M')"/></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="page">
                            <!-- Información General -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h4 class="text-primary">1. INFORMACIÓN GENERAL</h4>
                                    <table class="table table-bordered">
                                        <tr>
                                            <td width="25%"><strong>Centro de Trabajo:</strong></td>
                                            <td width="25%"><span t-field="workcenter.name"/></td>
                                            <td width="25%"><strong>Código:</strong></td>
                                            <td width="25%"><span t-field="workcenter.code"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Estado Actual:</strong></td>
                                            <td><span t-field="workcenter.machine_status"/></td>
                                            <td><strong>Operador Principal:</strong></td>
                                            <td><span t-field="workcenter.main_operator_id.name"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Capacidad Teórica:</strong></td>
                                            <td><span t-field="workcenter.theoretical_capacity"/> <span t-field="workcenter.capacity_unit"/>/h</td>
                                            <td><strong>Capacidad Real:</strong></td>
                                            <td><span t-field="workcenter.real_capacity"/> <span t-field="workcenter.capacity_unit"/>/h</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Métricas OEE -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h4 class="text-primary">2. MÉTRICAS OEE (Overall Equipment Effectiveness)</h4>
                                    <div class="row">
                                        <div class="col-3 text-center">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h1 class="text-primary"><span t-field="workcenter.oee_overall"/>%</h1>
                                                    <h5>OEE GENERAL</h5>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3 text-center">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h2 class="text-info"><span t-field="workcenter.oee_availability"/>%</h2>
                                                    <h6>DISPONIBILIDAD</h6>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3 text-center">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h2 class="text-warning"><span t-field="workcenter.oee_performance"/>%</h2>
                                                    <h6>RENDIMIENTO</h6>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-3 text-center">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h2 class="text-success"><span t-field="workcenter.oee_quality"/>%</h2>
                                                    <h6>CALIDAD</h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Información Técnica -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h4 class="text-primary">3. INFORMACIÓN TÉCNICA</h4>
                                    <table class="table table-bordered">
                                        <tr>
                                            <td width="25%"><strong>Consumo Energético:</strong></td>
                                            <td width="25%"><span t-field="workcenter.power_consumption_kw"/> kW</td>
                                            <td width="25%"><strong>Costo Energía/Hora:</strong></td>
                                            <td width="25%">$<span t-field="workcenter.energy_cost_per_hour"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tiempo Setup:</strong></td>
                                            <td><span t-field="workcenter.time_start"/> min</td>
                                            <td><strong>Tiempo Limpieza:</strong></td>
                                            <td><span t-field="workcenter.time_stop"/> min</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Costo Operativo/Hora:</strong></td>
                                            <td>$<span t-field="workcenter.costs_hour"/></td>
                                            <td><strong>Eficiencia Tiempo:</strong></td>
                                            <td><span t-field="workcenter.time_efficiency"/>%</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Mantenimiento -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h4 class="text-primary">4. INFORMACIÓN DE MANTENIMIENTO</h4>
                                    <table class="table table-bordered">
                                        <tr>
                                            <td width="25%"><strong>Último Mantenimiento:</strong></td>
                                            <td width="25%"><span t-field="workcenter.last_maintenance_date"/></td>
                                            <td width="25%"><strong>Próximo Mantenimiento:</strong></td>
                                            <td width="25%"><span t-field="workcenter.next_maintenance_date"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Intervalo Mantenimiento:</strong></td>
                                            <td><span t-field="workcenter.maintenance_hours_interval"/> horas</td>
                                            <td><strong>Horas Operación Total:</strong></td>
                                            <td><span t-field="workcenter.total_operation_hours"/> horas</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Equipos Asociados -->
                            <div class="row mb-4" t-if="workcenter.maintenance_equipment_ids">
                                <div class="col-12">
                                    <h4 class="text-primary">5. EQUIPOS ASOCIADOS</h4>
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr class="table-active">
                                                <th>Equipo</th>
                                                <th>Modelo</th>
                                                <th>Serie</th>
                                                <th>Ubicación</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="workcenter.maintenance_equipment_ids" t-as="equipment">
                                                <tr>
                                                    <td><span t-field="equipment.name"/></td>
                                                    <td><span t-field="equipment.model"/></td>
                                                    <td><span t-field="equipment.serial_no"/></td>
                                                    <td><span t-field="equipment.location"/></td>
                                                    <td><span t-field="equipment.maintenance_state"/></td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Operadores Certificados -->
                            <div class="row" t-if="workcenter.operator_ids">
                                <div class="col-12">
                                    <h4 class="text-primary">6. OPERADORES CERTIFICADOS</h4>
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr class="table-active">
                                                <th>Operador</th>
                                                <th>Departamento</th>
                                                <th>Email</th>
                                                <th>Teléfono</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="workcenter.operator_ids" t-as="operator">
                                                <tr>
                                                    <td><span t-field="operator.name"/></td>
                                                    <td><span t-field="operator.department_id.name"/></td>
                                                    <td><span t-field="operator.work_email"/></td>
                                                    <td><span t-field="operator.mobile_phone"/></td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>
            </t>
        </template>
        
        <!-- Menú Principal -->
        <menuitem id="megastock_machines_main_menu"
                  name="Máquinas MEGASTOCK"
                  parent="mrp.menu_mrp_root"
                  sequence="5"/>
        
        <menuitem id="machine_efficiency_dashboard_menu"
                  name="Dashboard de Eficiencia"
                  parent="megastock_machines_main_menu"
                  action="machine_efficiency_dashboard_action"
                  sequence="1"/>
        
    </data>
</odoo>