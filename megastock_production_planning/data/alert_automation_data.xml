<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Reglas de Automatizaci√≥n de Alertas por Defecto -->

    <!-- Regla 1: OEE Cr√≠tico -->
    <record id="alert_automation_oee_critical" model="megastock.alert.automation">
        <field name="name">OEE Cr√≠tico - Debajo del 70%</field>
        <field name="sequence">10</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando el OEE cae por debajo del 70% cr√≠tico</field>
        <field name="trigger_model">megastock.production.kpi</field>
        <field name="trigger_condition">record.kpi_type == 'oee' and record.value &lt; 70</field>
        <field name="alert_type">kpi</field>
        <field name="alert_priority">4</field>
        <field name="alert_severity">critical</field>
        <field name="alert_title_template">üö® OEE CR√çTICO: ${value}% en ${workcenter_id.name}</field>
        <field name="alert_message_template">El OEE ha ca√≠do a ${value}% en ${workcenter_id.name}, por debajo del umbral cr√≠tico de 70%. 

Componentes a revisar:
- Disponibilidad: Verificar paradas no planificadas
- Performance: Revisar velocidad de producci√≥n  
- Calidad: Verificar rechazos y reprocesos

Acci√≥n inmediata requerida.</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">30</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">15</field>
        <field name="only_working_hours" eval="False"/>
        <field name="auto_action_code">
# Crear an√°lisis autom√°tico de componentes OEE
if record.workcenter_id:
    env['megastock.production.analysis'].create({
        'name': f'An√°lisis OEE Cr√≠tico - {record.workcenter_id.name}',
        'analysis_type': 'oee_breakdown',
        'workcenter_id': record.workcenter_id.id,
        'trigger_alert_id': alert.id,
        'auto_generated': True
    })
_logger.info(f"An√°lisis OEE autom√°tico creado para alerta {alert.id}")
        </field>
    </record>

    <!-- Regla 2: Cola de Trabajo Saturada -->
    <record id="alert_automation_queue_saturated" model="megastock.alert.automation">
        <field name="name">Cola de Trabajo Saturada</field>
        <field name="sequence">20</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando una cola supera los 100 items</field>
        <field name="trigger_model">megastock.work.queue</field>
        <field name="trigger_condition">record.current_items_count > 100</field>
        <field name="alert_type">capacity</field>
        <field name="alert_priority">3</field>
        <field name="alert_severity">warning</field>
        <field name="alert_title_template">‚ö†Ô∏è Cola Saturada: ${name}</field>
        <field name="alert_message_template">La cola ${name} tiene ${current_items_count} items pendientes (L√≠mite recomendado: 100).

Estado actual:
- Items en cola: ${current_items_count}
- Tiempo promedio espera: ${avg_wait_time} min
- L√≠nea de producci√≥n: ${production_line}

Se recomienda optimizar o redistribuir carga.</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">60</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">45</field>
        <field name="auto_action_code">
# Intentar optimizaci√≥n autom√°tica de la cola
record.optimize_queue()
_logger.info(f"Optimizaci√≥n autom√°tica ejecutada en cola {record.name}")
        </field>
    </record>

    <!-- Regla 3: Producci√≥n Retrasada -->
    <record id="alert_automation_production_delayed" model="megastock.alert.automation">
        <field name="name">Producci√≥n Retrasada</field>
        <field name="sequence">30</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando una producci√≥n est√° retrasada</field>
        <field name="trigger_model">mrp.production</field>
        <field name="trigger_condition">record.date_planned_start &lt; datetime.now() and record.state not in ['done', 'cancel']</field>
        <field name="alert_type">schedule</field>
        <field name="alert_priority">3</field>
        <field name="alert_severity">warning</field>
        <field name="alert_title_template">üìÖ Producci√≥n Retrasada: ${name}</field>
        <field name="alert_message_template">La orden de producci√≥n ${name} est√° retrasada.

Detalles:
- Producto: ${product_id.name}
- Cantidad: ${product_qty} ${product_uom_id.name}
- Fecha programada: ${date_planned_start}
- Estado actual: ${state}

Revisar cronograma y reprogramar si es necesario.</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">120</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">60</field>
        <field name="only_working_hours" eval="True"/>
        <field name="working_hours_start">6.0</field>
        <field name="working_hours_end">22.0</field>
    </record>

    <!-- Regla 4: Calidad Baja -->
    <record id="alert_automation_quality_low" model="megastock.alert.automation">
        <field name="name">Calidad Baja - Debajo del 95%</field>
        <field name="sequence">40</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando la calidad cae por debajo del 95%</field>
        <field name="trigger_model">megastock.production.kpi</field>
        <field name="trigger_condition">record.kpi_type == 'quality' and record.value &lt; 95</field>
        <field name="alert_type">quality</field>
        <field name="alert_priority">4</field>
        <field name="alert_severity">error</field>
        <field name="alert_title_template">üî¥ Calidad Baja: ${value}% en ${workcenter_id.name}</field>
        <field name="alert_message_template">La calidad ha bajado a ${value}% en ${workcenter_id.name} (M√≠nimo aceptable: 95%).

Posibles causas:
- Problema en materias primas
- Desgaste de herramientas/moldes
- Configuraci√≥n incorrecta de m√°quina
- Falta de capacitaci√≥n del operador

Revisar inmediatamente proceso de producci√≥n.</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">20</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">10</field>
        <field name="max_alerts_per_hour">3</field>
        <field name="auto_action_code">
# Para alertas cr√≠ticas de calidad, marcar para revisi√≥n
if record.value &lt; 90:
    record.workcenter_id.message_post(
        body=f"Alerta cr√≠tica de calidad: {record.value}%. Revisar antes de continuar producci√≥n.",
        subject="‚ö†Ô∏è CALIDAD CR√çTICA"
    )
        </field>
    </record>

    <!-- Regla 5: Utilizaci√≥n Capacidad Alta -->
    <record id="alert_automation_capacity_high" model="megastock.alert.automation">
        <field name="name">Utilizaci√≥n de Capacidad Alta</field>
        <field name="sequence">50</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando la utilizaci√≥n supera el 95%</field>
        <field name="trigger_model">megastock.capacity.planning</field>
        <field name="trigger_condition">record.utilization_rate > 95 and record.state == 'active'</field>
        <field name="alert_type">capacity</field>
        <field name="alert_priority">3</field>
        <field name="alert_severity">warning</field>
        <field name="alert_title_template">‚ö° Capacidad al L√≠mite: ${utilization_rate}%</field>
        <field name="alert_message_template">La utilizaci√≥n de capacidad est√° al ${utilization_rate}%, cerca del l√≠mite m√°ximo.

Informaci√≥n del plan:
- Plan: ${name}
- Fecha: ${planning_date}
- Capacidad total: ${total_capacity}h
- Capacidad utilizada: ${utilized_capacity}h

Considerar redistribuci√≥n de carga o horas extra.</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">240</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">120</field>
    </record>

    <!-- Regla 6: Disponibilidad Baja -->
    <record id="alert_automation_availability_low" model="megastock.alert.automation">
        <field name="name">Disponibilidad Baja - Debajo del 85%</field>
        <field name="sequence">60</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando la disponibilidad cae por debajo del 85%</field>
        <field name="trigger_model">megastock.production.kpi</field>
        <field name="trigger_condition">record.kpi_type == 'availability' and record.value &lt; 85</field>
        <field name="alert_type">downtime</field>
        <field name="alert_priority">3</field>
        <field name="alert_severity">warning</field>
        <field name="alert_title_template">‚è∏Ô∏è Disponibilidad Baja: ${value}% en ${workcenter_id.name}</field>
        <field name="alert_message_template">La disponibilidad ha ca√≠do a ${value}% en ${workcenter_id.name} (M√≠nimo recomendado: 85%).

Posibles causas de tiempo muerto:
- Paradas no planificadas
- Mantenimiento correctivo
- Falta de materiales
- Cambios de producto/setup

Revisar causas de paradas y planificar mantenimiento preventivo.</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">45</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">30</field>
    </record>

    <!-- Regla 7: Performance Baja -->
    <record id="alert_automation_performance_low" model="megastock.alert.automation">
        <field name="name">Performance Baja - Debajo del 80%</field>
        <field name="sequence">70</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando el performance cae por debajo del 80%</field>
        <field name="trigger_model">megastock.production.kpi</field>
        <field name="trigger_condition">record.kpi_type == 'performance' and record.value &lt; 80</field>
        <field name="alert_type">kpi</field>
        <field name="alert_priority">3</field>
        <field name="alert_severity">warning</field>
        <field name="alert_title_template">üêå Performance Bajo: ${value}% en ${workcenter_id.name}</field>
        <field name="alert_message_template">El performance ha bajado a ${value}% en ${workcenter_id.name} (M√≠nimo recomendado: 80%).

Posibles causas:
- Velocidad de m√°quina reducida
- Micro-paradas frecuentes
- Falta de capacitaci√≥n del operador
- Problemas en materias primas

Revisar velocidad de producci√≥n y optimizar proceso.</field>
        <field name="line_filter">all</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">60</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">45</field>
    </record>

    <!-- Regla 8: Cuello de Botella Detectado -->
    <record id="alert_automation_bottleneck" model="megastock.alert.automation">
        <field name="name">Cuello de Botella Detectado</field>
        <field name="sequence">80</field>
        <field name="active" eval="True"/>
        <field name="description">Genera alerta cuando se detecta un cuello de botella</field>
        <field name="trigger_model">megastock.capacity.planning</field>
        <field name="trigger_condition">hasattr(record, 'bottleneck_severity') and record.bottleneck_severity == 'high'</field>
        <field name="alert_type">bottleneck</field>
        <field name="alert_priority">4</field>
        <field name="alert_severity">error</field>
        <field name="alert_title_template">üöß Cuello de Botella: ${name}</field>
        <field name="alert_message_template">Se ha detectado un cuello de botella de alta severidad en el plan ${name}.

Informaci√≥n:
- Fecha: ${planning_date}
- Utilizaci√≥n: ${utilization_rate}%
- Capacidad limitante identificada

Acciones recomendadas:
- Revisar asignaci√≥n de recursos
- Considerar subcontrataci√≥n
- Reprogramar √≥rdenes no cr√≠ticas</field>
        <field name="prevent_duplicates" eval="True"/>
        <field name="duplicate_window">180</field>
        <field name="auto_escalate" eval="True"/>
        <field name="escalation_time">60</field>
        <field name="auto_action_code">
# Ejecutar an√°lisis autom√°tico de cuellos de botella
record.analyze_bottlenecks()
_logger.info(f"An√°lisis de cuellos de botella ejecutado para plan {record.name}")
        </field>
    </record>

    <!-- Reglas de Escalaci√≥n por Defecto -->

    <!-- Escalaci√≥n para Alertas Cr√≠ticas -->
    <record id="escalation_rule_critical" model="megastock.alert.escalation.rule">
        <field name="name">Escalaci√≥n Alertas Cr√≠ticas</field>
        <field name="sequence">10</field>
        <field name="active" eval="True"/>
        <field name="severity">critical</field>
        <field name="escalation_time">15</field>
        <field name="max_escalations">3</field>
        <field name="production_line">all</field>
    </record>

    <!-- Escalaci√≥n para Alertas de Error -->
    <record id="escalation_rule_error" model="megastock.alert.escalation.rule">
        <field name="name">Escalaci√≥n Alertas de Error</field>
        <field name="sequence">20</field>
        <field name="active" eval="True"/>
        <field name="severity">error</field>
        <field name="escalation_time">30</field>
        <field name="max_escalations">2</field>
        <field name="production_line">all</field>
    </record>

    <!-- Escalaci√≥n para KPIs -->
    <record id="escalation_rule_kpi" model="megastock.alert.escalation.rule">
        <field name="name">Escalaci√≥n Alertas KPI</field>
        <field name="sequence">30</field>
        <field name="active" eval="True"/>
        <field name="alert_type">kpi</field>
        <field name="escalation_time">20</field>
        <field name="max_escalations">3</field>
        <field name="production_line">all</field>
    </record>

    <!-- Canal de Notificaci√≥n por Defecto -->
    <record id="notification_channel_internal" model="megastock.alert.notification.channel">
        <field name="name">Notificaciones Internas Odoo</field>
        <field name="active" eval="True"/>
        <field name="channel_type">internal</field>
        <field name="alert_types">all</field>
        <field name="min_priority">3</field>
    </record>

</odoo>