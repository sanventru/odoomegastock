<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Tree View -->
        <record id="view_production_plan_tree" model="ir.ui.view">
            <field name="name">megastock.production.plan.tree</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <tree string="Planes de Producción MEGASTOCK" decoration-success="state=='completed'" 
                      decoration-warning="state=='in_progress'" decoration-muted="state=='cancelled'">
                    <field name="name"/>
                    <field name="planning_date"/>
                    <field name="planning_type"/>
                    <field name="production_line_filter"/>
                    <field name="total_products"/>
                    <field name="total_quantity"/>
                    <field name="capacity_utilization" widget="percentage"/>
                    <field name="production_count"/>
                    <field name="state" widget="badge"/>
                    <field name="priority" invisible="1"/>
                </tree>
            </field>
        </record>

        <!-- Form View -->
        <record id="view_production_plan_form" model="ir.ui.view">
            <field name="name">megastock.production.plan.form</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <form string="Plan de Producción MEGASTOCK">
                    <header>
                        <button name="action_calculate_plan" type="object" string="Calcular Plan" 
                                class="btn-primary" states="draft,confirmed"/>
                        <button name="action_confirm" type="object" string="Confirmar" 
                                class="btn-primary" states="draft"/>
                        <button name="action_generate_productions" type="object" string="Generar Producciones" 
                                class="btn-success" states="confirmed,in_progress"/>
                        <button name="action_reschedule" type="object" string="Reprogramar" states="confirmed,in_progress"/>
                        <button name="action_view_productions" type="object" string="Ver Producciones" 
                                states="in_progress,completed" attrs="{'invisible': [('production_count', '=', 0)]}"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,in_progress,completed"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button class="oe_stat_button" type="object" name="action_view_productions" icon="fa-cogs">
                                <field string="Producciones" name="production_count" widget="statinfo"/>
                            </button>
                        </div>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>

                        <group>
                            <group name="basic_info">
                                <field name="planning_date"/>
                                <field name="date_from"/>
                                <field name="horizon_days"/>
                                <field name="date_to" readonly="1"/>
                                <field name="priority"/>
                            </group>
                            <group name="planning_config">
                                <field name="planning_type"/>
                                <field name="planning_method"/>
                                <field name="demand_source"/>
                                <field name="production_line_filter"/>
                            </group>
                        </group>

                        <group string="Configuración Avanzada">
                            <group name="optimization">
                                <field name="auto_reschedule"/>
                                <field name="consider_capacity_constraints"/>
                                <field name="include_forecast" attrs="{'invisible': [('demand_source', 'not in', ['forecast', 'mixed'])]}"/>
                                <field name="forecast_accuracy" widget="percentage" 
                                       attrs="{'invisible': [('include_forecast', '=', False)]}"/>
                            </group>
                            <group name="constraints">
                                <field name="safety_stock_days"/>
                                <field name="max_overtime_hours"/>
                                <field name="planned_efficiency" widget="percentage"/>
                            </group>
                        </group>

                        <group string="Recursos y Restricciones">
                            <field name="workcenter_ids" widget="many2many_tags"/>
                        </group>

                        <notebook>
                            <page string="Líneas del Plan" name="plan_lines">
                                <field name="plan_line_ids" nolabel="1">
                                    <tree editable="bottom" decoration-success="state=='completed'" 
                                          decoration-warning="state=='in_production'" decoration-muted="state=='cancelled'">
                                        <field name="product_id"/>
                                        <field name="planned_quantity"/>
                                        <field name="priority_score"/>
                                        <field name="estimated_hours"/>
                                        <field name="estimated_cost"/>
                                        <field name="suggested_start_date"/>
                                        <field name="suggested_end_date"/>
                                        <field name="workcenter_id"/>
                                        <field name="state" widget="badge"/>
                                        <field name="production_id" readonly="1"/>
                                    </tree>
                                </field>
                            </page>

                            <page string="Métricas y Resultados" name="metrics">
                                <group>
                                    <group string="Resumen del Plan">
                                        <field name="total_products" readonly="1"/>
                                        <field name="total_quantity" readonly="1"/>
                                        <field name="total_estimated_cost" readonly="1"/>
                                        <field name="capacity_utilization" widget="percentage" readonly="1"/>
                                        <field name="bottleneck_workcenter_id" readonly="1"/>
                                    </group>
                                    <group string="Cálculo">
                                        <field name="last_calculation_date" readonly="1"/>
                                        <field name="calculation_time" readonly="1"/>
                                    </group>
                                </group>

                                <group string="Log de Optimización" attrs="{'invisible': [('optimization_log', '=', False)]}">
                                    <field name="optimization_log" nolabel="1" readonly="1"/>
                                </group>
                            </page>

                            <page string="Notas" name="notes">
                                <field name="notes" nolabel="1"/>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Search View -->
        <record id="view_production_plan_search" model="ir.ui.view">
            <field name="name">megastock.production.plan.search</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <search string="Buscar Planes de Producción">
                    <field name="name" string="Nombre"/>
                    <field name="planning_date"/>
                    <field name="state"/>
                    <field name="planning_type"/>
                    <field name="production_line_filter"/>
                    <field name="workcenter_ids"/>
                    
                    <filter name="draft" string="Borrador" domain="[('state', '=', 'draft')]"/>
                    <filter name="confirmed" string="Confirmados" domain="[('state', '=', 'confirmed')]"/>
                    <filter name="in_progress" string="En Progreso" domain="[('state', '=', 'in_progress')]"/>
                    <filter name="completed" string="Completados" domain="[('state', '=', 'completed')]"/>
                    
                    <separator/>
                    <filter name="mrp_planning" string="Planificación MRP" domain="[('planning_type', '=', 'mrp')]"/>
                    <filter name="capacity_planning" string="Planificación por Capacidad" domain="[('planning_type', '=', 'capacity')]"/>
                    <filter name="mixed_planning" string="Planificación Mixta" domain="[('planning_type', '=', 'mixed')]"/>
                    
                    <separator/>
                    <filter name="current_week" string="Esta Semana" 
                            domain="[('planning_date', '&gt;=', (context_today + relativedelta(weeks=-1, day=1)).strftime('%Y-%m-%d')), 
                                     ('planning_date', '&lt;=', (context_today + relativedelta(weeks=0, day=7)).strftime('%Y-%m-%d'))]"/>
                    <filter name="this_month" string="Este Mes" 
                            domain="[('planning_date', '&gt;=', (context_today + relativedelta(day=1)).strftime('%Y-%m-%d')), 
                                     ('planning_date', '&lt;=', (context_today + relativedelta(months=1, day=1, days=-1)).strftime('%Y-%m-%d'))]"/>
                    
                    <separator/>
                    <filter name="high_priority" string="Alta Prioridad" domain="[('priority', 'in', ['high', 'urgent'])]"/>
                    <filter name="low_efficiency" string="Baja Eficiencia" domain="[('capacity_utilization', '&lt;', 75)]"/>
                    <filter name="overdue" string="Vencidos" domain="[('date_to', '&lt;', context_today), ('state', '!=', 'completed')]"/>
                    
                    <group expand="0" string="Agrupar Por">
                        <filter name="group_state" string="Estado" context="{'group_by': 'state'}"/>
                        <filter name="group_planning_type" string="Tipo Planificación" context="{'group_by': 'planning_type'}"/>
                        <filter name="group_line_filter" string="Línea Producción" context="{'group_by': 'production_line_filter'}"/>
                        <filter name="group_date" string="Fecha Planificación" context="{'group_by': 'planning_date'}"/>
                        <filter name="group_priority" string="Prioridad" context="{'group_by': 'priority'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Calendar View -->
        <record id="view_production_plan_calendar" model="ir.ui.view">
            <field name="name">megastock.production.plan.calendar</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <calendar string="Planificación de Producción" 
                          date_start="date_from" date_stop="date_to"
                          color="planning_type" mode="month">
                    <field name="name"/>
                    <field name="state"/>
                    <field name="total_products"/>
                    <field name="capacity_utilization"/>
                </calendar>
            </field>
        </record>

        <!-- Gantt View -->
        <record id="view_production_plan_gantt" model="ir.ui.view">
            <field name="name">megastock.production.plan.gantt</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <gantt string="Cronograma de Planes"
                       date_start="date_from" date_stop="date_to"
                       color="state" 
                       default_group_by="production_line_filter">
                    <field name="name"/>
                    <field name="priority"/>
                    <field name="capacity_utilization"/>
                </gantt>
            </field>
        </record>

        <!-- Kanban View -->
        <record id="view_production_plan_kanban" model="ir.ui.view">
            <field name="name">megastock.production.plan.kanban</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" class="o_kanban_small_column">
                    <field name="name"/>
                    <field name="planning_date"/>
                    <field name="state"/>
                    <field name="priority"/>
                    <field name="total_products"/>
                    <field name="capacity_utilization"/>
                    <field name="production_count"/>
                    
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="o_kanban_record_top mb8">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                    </div>
                                    <div class="o_kanban_record_title">
                                        <span class="badge badge-pill" t-attf-class="badge-{{priority == 'urgent' ? 'danger' : priority == 'high' ? 'warning' : 'secondary'}}">
                                            <field name="priority"/>
                                        </span>
                                    </div>
                                </div>

                                <div class="o_kanban_record_body">
                                    <div class="row">
                                        <div class="col-6">
                                            <span>📅 </span><field name="planning_date"/>
                                        </div>
                                        <div class="col-6">
                                            <span>📦 </span><field name="total_products"/> productos
                                        </div>
                                        <div class="col-6">
                                            <span>⚙️ </span><field name="capacity_utilization" widget="percentage"/>
                                        </div>
                                        <div class="col-6">
                                            <span>🏭 </span><field name="production_count"/> producciones
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Pivot View -->
        <record id="view_production_plan_pivot" model="ir.ui.view">
            <field name="name">megastock.production.plan.pivot</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <pivot string="Análisis de Planes de Producción">
                    <field name="planning_date" type="row" interval="week"/>
                    <field name="production_line_filter" type="col"/>
                    <field name="total_products" type="measure"/>
                    <field name="total_quantity" type="measure"/>
                    <field name="total_estimated_cost" type="measure"/>
                    <field name="capacity_utilization" type="measure"/>
                    <field name="production_count" type="measure"/>
                </pivot>
            </field>
        </record>

        <!-- Graph View -->
        <record id="view_production_plan_graph" model="ir.ui.view">
            <field name="name">megastock.production.plan.graph</field>
            <field name="model">megastock.production.plan</field>
            <field name="arch" type="xml">
                <graph string="Métricas de Planificación" type="bar">
                    <field name="planning_date" type="row" interval="week"/>
                    <field name="capacity_utilization" type="measure"/>
                    <field name="total_products" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- Action Window -->
        <record id="action_production_plan" model="ir.actions.act_window">
            <field name="name">Planes de Producción MEGASTOCK</field>
            <field name="res_model">megastock.production.plan</field>
            <field name="view_mode">kanban,tree,form,calendar,gantt,pivot,graph</field>
            <field name="search_view_id" ref="view_production_plan_search"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    ¡Crea tu primer Plan de Producción MEGASTOCK!
                </p>
                <p>
                    Los Planes de Producción te permiten:
                    <ul>
                        <li>📊 Planificar la producción usando algoritmos MRP avanzados</li>
                        <li>🎯 Optimizar capacidad y secuenciar órdenes automáticamente</li>
                        <li>📈 Analizar cuellos de botella y métricas de eficiencia</li>
                        <li>🚀 Generar órdenes de producción de forma inteligente</li>
                    </ul>
                </p>
            </field>
        </record>

        <!-- Action Window for Planner (BOM) -->
        <record id="action_production_planner_bom" model="ir.actions.act_window">
            <field name="name">Planificador - Listas de Materiales</field>
            <field name="res_model">mrp.bom</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[]</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    ¡Configura las Listas de Materiales para la planificación!
                </p>
                <p>
                    Las Listas de Materiales (BOM) definen:
                    <ul>
                        <li>🔧 Componentes necesarios para cada producto</li>
                        <li>📏 Cantidades exactas de cada material</li>
                        <li>⚙️ Operaciones de producción requeridas</li>
                        <li>🎯 Rutas de manufactura optimizadas</li>
                    </ul>
                </p>
            </field>
        </record>

        <!-- Menu Item -->
        <menuitem id="menu_production_planning_root"
                  name="Planificación"
                  parent="mrp.menu_mrp_root"
                  sequence="5"/>

        <menuitem id="menu_megastock_planner"
                  name="Planificador"
                  parent="menu_production_planning_root"
                  action="mrp.mrp_bom_form_action"
                  sequence="5"/>

        <menuitem id="menu_production_plan"
                  name="Ejecutar Planificador"
                  parent="menu_production_planning_root"
                  action="action_production_plan"
                  sequence="15"/>

    </data>
</odoo>